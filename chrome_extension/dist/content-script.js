class S{quotes=new Map;getArticleRootElement(){const e=["article",".article-body",".article_body","#articleBodyContents",".content","main"];for(const t of e){const o=document.querySelector(t);if(o&&o.innerText&&o.innerText.length>100)return o}return null}getHeadlineElements(){const e=["h1","h2",".media_end_head_headline","#title_area"],t=[];for(const o of e)document.querySelectorAll(o).forEach(i=>{i.innerText&&i.innerText.trim().length>0&&t.push(i)});return t}detectQuotes(){const e=this.extractArticleContent();if(!e)return[];const t=[/\u201c([\s\S]*?)\u201d/g,/"([\s\S]*?)"/g],o=[];let n=0;for(const i of t){let l;for(;(l=i.exec(e))!==null;){const s=l[1].trim();if(s.length>=10&&s.length<=500){const p=`quote-${n++}`;this.quotes.set(p,s),o.push({id:p,quote:s.substring(0,100),position:l.index})}}}return o}extractArticleContent(){let e="";const t=this.getArticleRootElement();t&&t.innerText&&t.innerText.length>100&&(e=t.innerText);const o=this.getHeadlineElements();if(o.length>0&&(e=`${o.map(i=>i.innerText).join(" ")} ${e}`.trim()),e.length<100){const n=document.body.innerText;n.length>100&&(e=n)}return e.replace(/\s+/g," ").trim()}getFullQuote(e){return this.quotes.get(e)}highlightQuotes(e){if(!e.length)return;const t=[];this.getHeadlineElements().forEach(d=>t.push(d));const n=this.getArticleRootElement();if(n&&t.push(n),!t.length)return;const i=/(\u201c[\s\S]*?\u201d|\u2018[\s\S]*?\u2019|"[\s\S]*?"|「[\s\S]*?」|『[\s\S]*?』|《[\s\S]*?》)/g,l=d=>d.replace(/[\u201c\u201d\u2018\u2019"「」『』《》]/g,"").replace(/\s+/g," ").trim(),s=new Map,p=new Map;e.forEach((d,w)=>{p.set(d.id,w+1);const y=this.getFullQuote(d.id)??d.quote,f=l(y);if(f){const c=s.get(f)??[];c.push(d.id),s.set(f,c)}}),t.forEach(d=>{const w=document.createTreeWalker(d,NodeFilter.SHOW_TEXT,null);let y;const f=[];for(;y=w.nextNode();){const c=y,u=c.parentElement;if(u&&u.classList.contains("quote-highlight"))continue;const h=c.textContent??"";i.lastIndex=0,i.test(h)&&f.push(c)}for(const c of f){const u=c.textContent??"";if(!u)continue;const h=document.createDocumentFragment();let x=0,b;for(i.lastIndex=0;(b=i.exec(u))!==null;){const q=b.index,E=i.lastIndex;q>x&&h.appendChild(document.createTextNode(u.slice(x,q)));const C=u.slice(q,E),g=l(C);let m;if(g){const r=s.get(g);r&&r.length>0&&(m=r.shift(),r.length===0?s.delete(g):s.set(g,r))}if(!m&&g){for(const[r,a]of s.entries())if(a.length&&(g.includes(r)||r.includes(g))){m=a.shift(),a.length?s.set(r,a):s.delete(r);break}}if(m){const r=document.createElement("mark");r.classList.add("quote-highlight"),r.dataset.quoteId=m,r.style.backgroundColor="#ffeb3b",r.style.padding="0 2px",r.style.borderRadius="3px",r.textContent=C;const a=document.createElement("span"),_=p.get(m);a.textContent=_?String(_):"",a.style.fontSize="0.75em",a.style.marginLeft="2px",a.style.verticalAlign="super",a.style.opacity="0.9",h.appendChild(r),h.appendChild(a)}else h.appendChild(document.createTextNode(C));x=E}x<u.length&&h.appendChild(document.createTextNode(u.slice(x))),c.parentNode&&c.parentNode.replaceChild(h,c)}})}}class T{detector=new S;openInlineSidePanel(){const e=document.getElementById("qop-side-panel-container");if(e){e.style.display="block";return}const t=document.createElement("div");t.id="qop-side-panel-container",Object.assign(t.style,{position:"fixed",top:"0",right:"0",width:"420px",height:"100vh",zIndex:"2147483647",backgroundColor:"white",boxShadow:"0 0 10px rgba(0,0,0,0.3)",borderLeft:"1px solid rgba(0,0,0,0.1)"});const o=document.createElement("iframe");o.src=chrome.runtime.getURL("html/side-panel.html"),o.style.width="100%",o.style.height="100%",o.style.border="none",t.appendChild(o),document.body.appendChild(t)}initialize(){const e=/^https:\/\/n\.news\.naver\.com\/mnews\/article\//.test(window.location.href);if(console.log("Current URL:",window.location.href),console.log("Is Naver News:",e),!e){console.warn("This script only runs on Naver News article pages.");return}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>this.onPageReady()):this.onPageReady(),chrome.runtime.onMessage.addListener((t,o,n)=>{t.action==="detect_quotes"&&(this.detectAndHighlight(),n({success:!0}))})}onPageReady(){this.detectAndHighlight()}detectAndHighlight(){const e=this.detector.detectQuotes();e.length!==0&&(this.detector.highlightQuotes(e),this.addQuoteClickListeners(e),this.runBackendForAllQuotes(e))}addQuoteClickListeners(e){const t=new Map(e.map(n=>[n.id,n]));document.querySelectorAll("mark.quote-highlight").forEach(n=>{const i=n.dataset.quoteId;if(!i)return;const l=t.get(i);l&&(n.style.cursor="pointer",n.style.transition="all 0.2s",n.addEventListener("mouseenter",()=>{n.style.filter="brightness(0.9)"}),n.addEventListener("mouseleave",()=>{n.style.filter="brightness(1)"}),n.addEventListener("click",()=>{this.onQuoteClick(l)}))})}async onQuoteClick(e){const t=this.detector.getFullQuote(e.id);if(!t)return;const o=this.extractArticleData();this.openInlineSidePanel(),chrome.runtime.sendMessage({action:"start_loading"}),chrome.runtime.sendMessage({action:"set_loading_state",isLoading:!0}),chrome.runtime.sendMessage({action:"find_origin",payload:{quote_id:e.id,quote_content:t,article_text:o.content,article_url:window.location.href,article_title:o.title,keywords:o.keywords}},n=>{if(!n?.success){console.error("Background find_origin failed:",n?.error);return}const i=n.data;chrome.runtime.sendMessage({action:"display_results",data:i})})}extractArticleData(){const e=["article",".article-body",".article_body","#articleBodyContents",".content","main"];let t="";for(const l of e){const s=document.querySelector(l);if(s&&s.textContent&&s.textContent.length>100){t=s.textContent;break}}t=t.replace(/\s+/g," ").trim();const n=document.querySelector('h1, .title, [role="heading"]')?.textContent||document.title,i=this.extractKeywords(t);return{content:t,keywords:i,title:n}}extractKeywords(e){return e.split(/\s+/).filter(o=>o.length>3).slice(0,10)}runBackendForAllQuotes(e){if(!e.length)return;const t=this.extractArticleData();(async()=>{for(const n of e){const i=this.detector.getFullQuote(n.id)??n.quote;await new Promise(l=>{chrome.runtime.sendMessage({action:"find_origin",payload:{quote_id:n.id,quote_content:i,article_text:t.content,article_url:window.location.href,article_title:t.title,keywords:t.keywords}},s=>{s?.success||console.error("Background find_origin failed (bulk):",s?.error),l()})})}})().catch(n=>{console.error("Error while running bulk quote analysis:",n)})}}const Q=new T;Q.initialize();
