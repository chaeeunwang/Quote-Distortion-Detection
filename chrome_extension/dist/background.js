class n{latestResults=[];isLoading=!1;cacheByQuoteId={};initialize(){chrome.runtime.onMessage.addListener((t,o,i)=>{if(console.log("[Background] Received message:",t.action),t.action==="display_results")this.latestResults=t.data,this.isLoading=!1,i({success:!0});else if(t.action==="get_latest_results")i({results:this.latestResults,isLoading:this.isLoading});else if(t.action==="set_loading_state")this.isLoading=!!t.isLoading,i({success:!0});else if(t.action==="find_origin")return this.handleFindOrigin(t.payload).then(s=>{i({success:!0,data:s})}).catch(s=>{console.error("[Background] Error in find_origin:",s),i({success:!1,error:String(s)})}),!0})}async handleFindOrigin(t){const o=t.quote_id;if(o&&this.cacheByQuoteId[o])return this.latestResults=this.cacheByQuoteId[o],this.isLoading=!1,this.cacheByQuoteId[o];this.isLoading=!0;const i=await fetch("http://localhost:8000/api/find-origin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!i.ok){const e=await i.text();throw new Error(`HTTP ${i.status}: ${e}`)}const s=await i.json(),a=(Array.isArray(s.candidates)?s.candidates:[]).map(e=>({quote_id:s.quote_id,quote:s.quote_content,original_span:e.original_span,similarity_score:Math.round((e.similarity_score??0)*100),distortion_score:typeof e.distortion_score=="number"?e.distortion_score:null,is_distorted:typeof e.is_distorted=="boolean"?e.is_distorted:null,source_url:e.source_url}));return this.latestResults=a,o&&(this.cacheByQuoteId[o]=a),this.isLoading=!1,a}}const r=new n;r.initialize();
